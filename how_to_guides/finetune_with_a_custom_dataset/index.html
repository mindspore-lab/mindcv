
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mindspore-lab.github.io/mindcv/how_to_guides/finetune_with_a_custom_dataset/">
      
      
        <link rel="prev" href="../feature_extraction/">
      
      
        <link rel="next" href="../../reference/data/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Fine-tune with A Custom Dataset - MindCV Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fine-tune-with-a-custom-dataset" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="MindCV Docs" class="md-header__button md-logo" aria-label="MindCV Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MindCV Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Fine-tune with A Custom Dataset
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="./" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../zh/how_to_guides/finetune_with_a_custom_dataset/" hreflang="zh" class="md-select__link">
              中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/mindspore-lab/mindcv" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    mindspore-lab/mindcv
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../installation/" class="md-tabs__link">
        
  
  
    
  
  Installation

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../modelzoo/" class="md-tabs__link">
        
  
  
    
  
  Model Zoo

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tutorials/quick_start/" class="md-tabs__link">
          
  
  
    
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../write_a_new_model/" class="md-tabs__link">
          
  
  
    
  
  How-To Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../reference/data/" class="md-tabs__link">
          
  
  
    
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../notes/changelog/" class="md-tabs__link">
          
  
  
    
  
  Notes

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MindCV Docs" class="md-nav__button md-logo" aria-label="MindCV Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    MindCV Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mindspore-lab/mindcv" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    mindspore-lab/mindcv
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelzoo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model Zoo
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/quick_start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/finetune/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Finetune
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inference
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    How-To Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            How-To Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../write_a_new_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Write A New Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../feature_extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Scale Feature Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Fine-tune with A Custom Dataset
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Fine-tune with A Custom Dataset
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#data-preprocessing" class="md-nav__link">
    <span class="md-ellipsis">
      Data Preprocessing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Preprocessing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-custom-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      Read Custom Dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Read Custom Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-dataset-offline" class="md-nav__link">
    <span class="md-ellipsis">
      Read Dataset Offline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-dataset-online" class="md-nav__link">
    <span class="md-ellipsis">
      Read Dataset Online
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#augmentation-and-batching" class="md-nav__link">
    <span class="md-ellipsis">
      Augmentation and Batching
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fine-tuning" class="md-nav__link">
    <span class="md-ellipsis">
      Fine-tuning
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fine-tuning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fine-tuning-all-the-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Fine-tuning All the Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#freeze-feature-network" class="md-nav__link">
    <span class="md-ellipsis">
      Freeze Feature Network
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Freeze Feature Network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linear-probe" class="md-nav__link">
    <span class="md-ellipsis">
      Linear Probe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#freeze-part-of-the-feature-network" class="md-nav__link">
    <span class="md-ellipsis">
      Freeze Part of the Feature Network
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-learning-rate-for-specific-layers" class="md-nav__link">
    <span class="md-ellipsis">
      Set Learning Rate for Specific Layers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Set Learning Rate for Specific Layers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-learning-rate-for-classifier" class="md-nav__link">
    <span class="md-ellipsis">
      Set Learning Rate for Classifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-learning-rate-for-any-layers-in-feature-network" class="md-nav__link">
    <span class="md-ellipsis">
      Set Learning Rate for Any Layers in Feature Network
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prediction" class="md-nav__link">
    <span class="md-ellipsis">
      Prediction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/loss/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    loss
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/models.layers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    models.layers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/optim/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    optim
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/scheduler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    scheduler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Notes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Notes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Change Log
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/code_of_conduct/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code of Conduct
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#data-preprocessing" class="md-nav__link">
    <span class="md-ellipsis">
      Data Preprocessing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Preprocessing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-custom-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      Read Custom Dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Read Custom Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-dataset-offline" class="md-nav__link">
    <span class="md-ellipsis">
      Read Dataset Offline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-dataset-online" class="md-nav__link">
    <span class="md-ellipsis">
      Read Dataset Online
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#augmentation-and-batching" class="md-nav__link">
    <span class="md-ellipsis">
      Augmentation and Batching
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fine-tuning" class="md-nav__link">
    <span class="md-ellipsis">
      Fine-tuning
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fine-tuning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fine-tuning-all-the-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Fine-tuning All the Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#freeze-feature-network" class="md-nav__link">
    <span class="md-ellipsis">
      Freeze Feature Network
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Freeze Feature Network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linear-probe" class="md-nav__link">
    <span class="md-ellipsis">
      Linear Probe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#freeze-part-of-the-feature-network" class="md-nav__link">
    <span class="md-ellipsis">
      Freeze Part of the Feature Network
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-learning-rate-for-specific-layers" class="md-nav__link">
    <span class="md-ellipsis">
      Set Learning Rate for Specific Layers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Set Learning Rate for Specific Layers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-learning-rate-for-classifier" class="md-nav__link">
    <span class="md-ellipsis">
      Set Learning Rate for Classifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-learning-rate-for-any-layers-in-feature-network" class="md-nav__link">
    <span class="md-ellipsis">
      Set Learning Rate for Any Layers in Feature Network
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prediction" class="md-nav__link">
    <span class="md-ellipsis">
      Prediction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/mindspore-lab/mindcv/edit/master/docs/en/how_to_guides/finetune_with_a_custom_dataset.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/mindspore-lab/mindcv/raw/master/docs/en/how_to_guides/finetune_with_a_custom_dataset.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="fine-tune-with-a-custom-dataset">Fine-tune with A Custom Dataset<a class="headerlink" href="#fine-tune-with-a-custom-dataset" title="Permanent link">&para;</a></h1>
<p>This document introduces the process for fine-tuning a custom dataset in MindCV and the implementation of fine-tuning techniques such as reading the dataset online, setting the learning rate for specific layers, freezing part of the parameters, etc. The main code is in./example/finetune.py, you can make changes to it based on this tutorial as needed.</p>
<p>Next, we will use the FGVC-Aircraft dataset as an example to show how to fine-tune the pre-trained model mobilenet v3-small. <a href="https://www.robots.ox.ac.uk/~vgg/data/fgvc-aircraft/">Fine-Grained Visual Classification of Aircraft</a> is a commonly used fine-grained image Classification benchmark dataset, which contains 10,000 aircraft images from 100 different types of aircraft (a.k.a variants), that is, 100 images for each aircraft type.</p>
<p>First, extract the downloaded dataset to . /data folder, the directory structure of the Aircraft dataset is:</p>
<div class="highlight"><pre><span></span><code>aircraft
└── data
    ├── images
    │   ├── image1.jpg
    │   ├── image2.jpg
    │   └── ....
    ├── images_variant_test.txt
    ├── images_variant_trainval.txt
    └── ....
</code></pre></div>
<p>The folder "images" contains all the 10,000 images, and the airplane types and subset names of each image are recorded in images_variant_*.txt. When this dataset is used for fine-tuning, the training set is usually set by annotation file: images_variant_trainval.txt. Hence, the training set should contain 6667 images and the test set should contain 3333 images after the dataset has been split.</p>
<h2 id="data-preprocessing">Data Preprocessing<a class="headerlink" href="#data-preprocessing" title="Permanent link">&para;</a></h2>
<h3 id="read-custom-dataset">Read Custom Dataset<a class="headerlink" href="#read-custom-dataset" title="Permanent link">&para;</a></h3>
<p>For custom datasets, you can either organize the dataset file directory locally into a tree structure similar to ImageNet, and then use the function <code>create_dataset</code> to read the dataset (offline way), or if your dataset is medium-scale or above, which is not suitable to use offline way, you can also directly <a href="https://www.mindspore.cn/tutorials/en/r2.1/beginner/dataset.html#customizing-dataset">read all the images into a mappable or iterable object</a>, replacing the file splitting and the <code>create_dataset</code> steps (online way).</p>
<h4 id="read-dataset-offline">Read Dataset Offline<a class="headerlink" href="#read-dataset-offline" title="Permanent link">&para;</a></h4>
<p>The function <code>create_dataset</code> uses <a href="https://www.mindspore.cn/docs/zh-CN/r2.0/api_python/dataset/mindspore.dataset.ImageFolderDataset.html#mindspore.dataset.ImageFolderDataset"><code>mindspore.Dataset.ImageFolderDataset</code></a> function to build a dataset object, all images in the same folder will be assigned a same label, which is the folder name. Therefore, the prerequisite for using this function is that the file directory of the source dataset should follow the following tree structure:</p>
<div class="highlight"><pre><span></span><code>DATASET_NAME
    ├── split1(e.g. train)/
    │  ├── class1/
    │  │   ├── 000001.jpg
    │  │   ├── 000002.jpg
    │  │   └── ....
    │  └── class2/
    │      ├── 000001.jpg
    │      ├── 000002.jpg
    │      └── ....
    └── split2/
       ├── class1/
       │   ├── 000001.jpg
       │   ├── 000002.jpg
       │   └── ....
       └── class2/
           ├── 000001.jpg
           ├── 000002.jpg
           └── ....
</code></pre></div>
<p>Next, we'll take the annotation file ./aircraft/data/images_variant_trainval.txt as an example, locally generate the file of train set ./aircraft/data/images/trainval/, which meets the request of a tree-structure directory.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>


<span class="c1"># only for Aircraft dataset but not a general one</span>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_images</span><span class="p">(</span><span class="n">images_path</span><span class="p">,</span> <span class="n">subset_name</span><span class="p">,</span> <span class="n">annotation_file_path</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># read the annotation file to get the label of each image</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">annotations</span><span class="p">(</span><span class="n">annotation_file_path</span><span class="p">):</span>
        <span class="n">image_label</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">annotation_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">image_label</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">image_label</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">image_label</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">image_label</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">image_label</span>

    <span class="c1"># make a new folder for subset</span>
    <span class="n">subset_path</span> <span class="o">=</span> <span class="n">images_path</span> <span class="o">+</span> <span class="n">subset_name</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">subset_path</span><span class="p">)</span>

    <span class="c1"># extract and copy/move images to the new folder</span>
    <span class="n">image_label</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">(</span><span class="n">annotation_file_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">image_label</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">label_folder</span> <span class="o">=</span> <span class="n">subset_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">label</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">label_folder</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">image_label</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
            <span class="n">image_name</span> <span class="o">=</span> <span class="n">image</span> <span class="o">+</span> <span class="s2">&quot;.jpg&quot;</span>
            <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">images_path</span> <span class="o">+</span> <span class="n">image_name</span><span class="p">,</span> <span class="n">label_folder</span> <span class="o">+</span> <span class="n">image_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">images_path</span> <span class="o">+</span> <span class="n">image_name</span><span class="p">,</span> <span class="n">label_folder</span><span class="p">)</span>


<span class="c1"># take train set of aircraft dataset as an example</span>
<span class="n">images_path</span> <span class="o">=</span> <span class="s2">&quot;./aircraft/data/images/&quot;</span>
<span class="n">subset_name</span> <span class="o">=</span> <span class="s2">&quot;trainval&quot;</span>
<span class="n">annotation_file_path</span> <span class="o">=</span> <span class="s2">&quot;./aircraft/data/images_variant_trainval.txt&quot;</span>
<span class="n">extract_images</span><span class="p">(</span><span class="n">images_path</span><span class="p">,</span> <span class="n">subset_name</span><span class="p">,</span> <span class="n">annotation_file_path</span><span class="p">)</span>
</code></pre></div>
<p>The splitting method of the test set is the same as that of the training set. The file structure of the whole Aircraft dataset should be:</p>
<div class="highlight"><pre><span></span><code>aircraft
└── data
    └── images
        ├── trainval
        │   ├── 707-320
        │   │   ├── 0056978.jpg
        │   │   └── ....
        │   ├── 727-200
        │   │   ├── 0048341.jpg
        │   │   └── ....
        │   └── ....
        └── test
            ├── 707-320
            │   ├── 0062765.jpg
            │   └── ....
            ├── 727-200
            │   ├── 0061581.jpg
            │   └── ....
            └── ....
</code></pre></div>
<p>./example/finetune.py integrates the whole training pipeline, from pre-processing to the establishment and training of the model: <code>create_dataset</code> -&gt; <code>create_transforms</code> -&gt; <code>create_loader</code> -&gt; <code>create_model</code> -&gt;..., thus, the dataset with the adequate file directory structure can be sent directly to the fine-tuning script to start the subsequent processes including loading dataset and model training by running <code>python ./example/finetune.py --data_dir=./aircraft/data/images/</code> command. For custom datasets, please note that<font color=DarkRed> the dataset parameter in the configuration file must be set to an empty string <code>""</code> </font> in advance.</p>
<h4 id="read-dataset-online">Read Dataset Online<a class="headerlink" href="#read-dataset-online" title="Permanent link">&para;</a></h4>
<p>Offline data reading takes up extra local disk space to store the newly generated data files. Therefore, when the local storage space is insufficient or the data cannot be backed up to the local environment, the local data files cannot be read using <code>create_dataset</code> directly, you can write a function to read the dataset in an online way.</p>
<p>Here's how we generate a random-accessible dataset object that stores the images of the training set and realize a map from indices to data samples:</p>
<ul>
<li>
<p>First, we define a class <code>ImageClsDataset</code> to read the raw data and transform them into a random-accessible dataset:</p>
<ul>
<li>In the initialization function <code>__init__()</code>, the annotation file path such as ./aircraft/data/images_variant_trainval.txt is taken as input, and used to generate a dictionary <code>self.annotation</code> that stores the one-to-one correspondence between images and tags;</li>
<li>Since <code>create_loader</code> will perform a map operation on this iterated object, which does not support string format labels, it is also necessary to generate <code>self.label2id</code> to<font color=DarkRed> convert the string format label in <code>self.annotation</code> to integer type</font>;</li>
<li>Based on the information stored in <code>self.annotation</code>, we next <font color=DarkRed>read each image in the training set as a one-dimensional array </font> from the folder ./aircraft/data/images/ (the image data must be read as an one-dimensional array due to map operation restrictions in <code>create_loader</code>). The image information and label are stored in <code>self._data</code> and <code>self._label</code> respectively.</li>
<li>Next, the mappable object is constructed using the <code>__getitem__</code> function.</li>
<li>After writing the ImageClsDataset class, we can pass it the path of the annotation file to instantiate it, and load it as a dataset that can be read by the model through <a href="https://www.mindspore.cn/docs/zh-CN/r2.0/api_python/dataset/mindspore.dataset.GeneratorDataset.html#mindspore.dataset.GeneratorDataset"><code>mindspore.dataset.GeneratorDataset</code></a>. Note that <font color=DarkRed>the parameter <code>column_names</code> must be set to be ["image", "label"]</font> for subsequent reading by other functions. What we've got now is supposed to be the same as what's generated by <code>create_dataset</code>.</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">mindspore.dataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeneratorDataset</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ImageClsDataset</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotation_dir</span><span class="p">,</span> <span class="n">images_dir</span><span class="p">):</span>
        <span class="c1"># Read annotations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">annotation_dir</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">image_label</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image_label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.jpg&quot;</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_label</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="n">image</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>

        <span class="c1"># Transfer string-type label to int-type label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label2id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label2id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="n">image</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label2id</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

        <span class="c1"># Read image-labels as mappable object</span>
        <span class="n">label2images</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">label2id</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">read_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">images_dir</span> <span class="o">+</span> <span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">label2images</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_image</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">label2images</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">label2images</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">label2images</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span> <span class="p">[])</span>

    <span class="c1"># make class ImageClsDataset a mappable object</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>


<span class="c1"># take aircraft dataset as an example</span>
<span class="n">annotation_dir</span> <span class="o">=</span> <span class="s2">&quot;./aircraft/data/images_variant_trainval.txt&quot;</span>
<span class="n">images_dir</span> <span class="o">=</span> <span class="s2">&quot;./aircraft/data/images/&quot;</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">ImageClsDataset</span><span class="p">(</span><span class="n">annotation_dir</span><span class="p">,</span> <span class="n">images_dir</span><span class="p">)</span>
<span class="n">dataset_train</span> <span class="o">=</span> <span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">column_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>Compared with the offline way, the online way skipped the step of splitting the data file locally and reading the local file with the <code>create_dataset</code> function. So in the subsequent training, simply <strong>replace the part of finetune.py that uses <code>create_dataset</code> with the above code</strong>, then you can start training by running finetune.py directly as what you do after reading the dataset offline.</p>
<h3 id="augmentation-and-batching">Augmentation and Batching<a class="headerlink" href="#augmentation-and-batching" title="Permanent link">&para;</a></h3>
<p>MindCV uses the <code>create_loader</code> function to perform data augmentation and batching for the dataset read in the previous chapter. Augmentation strategies are defined in advance by the <code>create_transforms</code> function. Batching is set by the parameter <code>batch_size</code> in the <code>create_loader</code> function. All hyperparameters mentioned above can be passed through the model configuration file. Hyper-parameters' specific usage see the <a href="https://mindspore-lab.github.io/mindcv/zh/reference/data/">API documentation</a>.</p>
<p>For small-size custom datasets, it is suggested that data augmentation can be used to the training set to enhance the generalization of the model and prevent overfitting. For the dataset of fine-grained image classification tasks, such as the Aircraft dataset in this tutorial, the classification effect may be not that ideal due to the large variance within the data class, the image size can be set larger by adjusting the hyper-parameter <code>image_resize</code> (such as 448, 512, 600, etc.).</p>
<h2 id="fine-tuning">Fine-tuning<a class="headerlink" href="#fine-tuning" title="Permanent link">&para;</a></h2>
<p>Referring to <a href="https://cs231n.github.io/transfer-learning/#tf">Stanford University CS231n</a>, <strong>fine-tuning all the parameters</strong>, <strong>freezing feature network</strong>, and <strong>setting learning rates for specific layers</strong> are commonly used fine-tuning skills. The first one uses pre-trained weights to initialize the parameters of the target model, and then updates all parameters based on the new dataset, so it's usually time-consuming but will get a high precision. Freezing feature networks are divided into freezing all feature networks(linear probe) and freezing partial feature networks. The former uses the pre-trained model as a feature extractor and only updates the parameters of the full connection layer, which takes a short time but has low accuracy; The latter generally freezes the parameters of shallow layers, which only learn the basic features of images, and only updates the parameters of the deep network and the full connection layer. Setting learning rate for specific layers is similar but more elaborate, it specifies the learning rates used by certain layers during training.</p>
<p>For hyper-parameters used in fine-tuning training, you can refer to the configuration file used when pre-training on the ImageNet-1k dataset in ./configs. Note that for fine-tuning, <font color=DarkRed>the hyper-parameter <code>pretrained</code> should be set to be <code>True</code> </font>to load the pre-training weight, <font color=DarkRed> <code>num_classes</code> should be set to be the number of labels </font>of the custom dataset (e.g. 100 for the Aircraft dataset here), moreover, don't forget to <font color=DarkRed>reduce batch_size and epoch_size </font>based on the size of the custom dataset. In addition, since the pre-trained weight already contains a lot of information for identifying images, in order not to destroy this information too much, it is also necessary to<font color=DarkRed> reduce the learning rate <code>lr</code> </font>, and it is also recommended to start training and adjust from at most one-tenth of the pre-trained learning rate or 0.0001. These parameters can be modified in the configuration file or added in the shell command as shown below. The training results can be viewed in the file ./ckpt/results.txt.</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>.examples/finetune/finetune.py<span class="w"> </span>--config<span class="o">=</span>./configs/mobilenetv3/mobilnet_v3_small_ascend.yaml<span class="w"> </span>--data_dir<span class="o">=</span>./aircraft/data<span class="w"> </span>--pretrained<span class="o">=</span>True
</code></pre></div>
<p>When fine-tuning mobilenet v3-small based on Aircraft dataset, this tutorial mainly made the following changes to the hyper-parameters:</p>
<table>
<thead>
<tr>
<th>Hyper-parameter</th>
<th>Pretrain</th>
<th>Fine-tune</th>
</tr>
</thead>
<tbody>
<tr>
<td>dataset</td>
<td>"imagenet"</td>
<td>""</td>
</tr>
<tr>
<td>batch_size</td>
<td>75</td>
<td>8</td>
</tr>
<tr>
<td>image_resize</td>
<td>224</td>
<td>600</td>
</tr>
<tr>
<td>auto_augment</td>
<td>-</td>
<td>"randaug-m7-mstd0.5"</td>
</tr>
<tr>
<td>num_classes</td>
<td>1000</td>
<td>100</td>
</tr>
<tr>
<td>pretrained</td>
<td>False</td>
<td>True</td>
</tr>
<tr>
<td>epoch_size</td>
<td>470</td>
<td>50</td>
</tr>
<tr>
<td>lr</td>
<td>0.77</td>
<td>0.002</td>
</tr>
</tbody>
</table>
<h3 id="fine-tuning-all-the-parameters">Fine-tuning All the Parameters<a class="headerlink" href="#fine-tuning-all-the-parameters" title="Permanent link">&para;</a></h3>
<p>Since the progress of this type of fine-tuning is the same as training from scratch, simply <strong>start the training by running finetune.py</strong> and adjust the parameters as training from scratch.</p>
<h3 id="freeze-feature-network">Freeze Feature Network<a class="headerlink" href="#freeze-feature-network" title="Permanent link">&para;</a></h3>
<h4 id="linear-probe">Linear Probe<a class="headerlink" href="#linear-probe" title="Permanent link">&para;</a></h4>
<p>We prevent parameters from updating by setting <code>requires_grad=False</code> for all parameters except those in the full connection layer. In finetune.py, add the following code after <code>create_model</code> :</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mindcv.models.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">_model_pretrained_cfgs</span>

<span class="c1"># ...create_model()</span>

<span class="c1"># number of parameters to be updated</span>
<span class="n">num_params</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># read names of parameters in FC layer</span>
<span class="n">classifier_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">_model_pretrained_cfgs</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.weight&quot;</span><span class="p">,</span>
                    <span class="n">_model_pretrained_cfgs</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.bias&quot;</span><span class="p">]</span>

<span class="c1"># prevent parameters in network(except the classifier) from updating</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">classifier_names</span><span class="p">:</span>
        <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
<h4 id="freeze-part-of-the-feature-network">Freeze Part of the Feature Network<a class="headerlink" href="#freeze-part-of-the-feature-network" title="Permanent link">&para;</a></h4>
<p>To balance the speed and precision of fine-tuning, we can also fix some target network parameters and train the parameters in the deep layer only. It is necessary to extract the parameter names in those layers to be frozen and slightly modify the code in the last chapter. By printing the result of <code>create_model</code> -- <code>network</code>, we can see that in MindCV, each layer of the network of mobilenet v3-small is named with <code>features.*</code>. Suppose that we freeze only the first 7 layers of the network, add the following code after <code>create_model</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ...create_model()</span>

<span class="c1"># read names of network layers</span>
<span class="n">freeze_layer</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;features.&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>

<span class="c1"># prevent parameters in the first 7 layers of the network from updating</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">freeze_layer</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
<h3 id="set-learning-rate-for-specific-layers">Set Learning Rate for Specific Layers<a class="headerlink" href="#set-learning-rate-for-specific-layers" title="Permanent link">&para;</a></h3>
<p>To further improve the training accuracy of a fine-tuned model, we can set different learning rates for different layers in the network. This is because the shallow part of the network generally recognizes common contours or features, so even if parameters in this part will be updated, the learning rate should be set relatively small; The deep part generally recognizes the detailed personal characteristics of an object, so the learning rate can be set relatively large; Compared with the feature network that needs to retain the pre-training information as much as possible, the classifier needs to be trained from the beginning, hence the learning rate can be appropriately increased. Since this operation is elaborate, we need to enter finetune.py to specify the parameter names of specific layers and the corresponding learning rates.</p>
<p>MindCV uses <a href="https://mindspore-lab.github.io/mindcv/zh/reference/optim/#mindcv.optim.optim_factory.create_optimizer"><code>create_optimizer</code></a> to generate the optimizer and passes the learning rate to the optimizer. To set the tiered learning rate, simply <strong>change the <code>params</code> parameter of <code>create_optimizer</code> function in finetune.py from <code>network.trainable_params()</code> to a list containing the names of the specific parameters and the corresponding learning rate</strong>, which you can refer to the <a href="https://www.mindspore.cn/docs/zh-CN/r2.0/api_python/mindspore.nn.html#%E4%BC%98%E5%8C%96%E5%99%A8">API documentation of optimizers</a>. The specific structure of the network and the parameter names in each layer can be viewed by printing the result of <code>create_model</code> -- <code>network</code>.</p>
<blockquote>
<p>Tips: You can also use the same operation to set different weight_decay for parameters.</p>
</blockquote>
<h4 id="set-learning-rate-for-classifier">Set Learning Rate for Classifier<a class="headerlink" href="#set-learning-rate-for-classifier" title="Permanent link">&para;</a></h4>
<p>Taking mobilenet v3-small as an example, the model classifier name starts with "classifier", so if we only increase the learning rate of the classifier, we need to specify it at each step of training. <code>lr_scheduler</code> is a learning rate list generated by <code>create_scheduler</code>, which contains the learning rate at each step of training. Suppose we adjust the learning rate of the classifier to 1.2 times that on the feature network. The changes to the finetune.py code are as follows:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ...</span>


<span class="c1"># Note: a)the params-lr dict must contain all the parameters. b)Also, you&#39;re recommended to set a dict with a key &quot;order_params&quot; to make sure the parameters will be updated in the right order.</span>
<span class="n">params_lr_group</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;classifier&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">())),</span>
                    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mf">1.2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lr_scheduler</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;classifier&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">())),</span>
                    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">lr_scheduler</span><span class="p">},</span>
                   <span class="p">{</span><span class="s2">&quot;order_params&quot;</span><span class="p">:</span> <span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()}]</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">create_optimizer</span><span class="p">(</span><span class="n">params_lr_group</span><span class="p">,</span>
                             <span class="n">opt</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span>
                             <span class="n">lr</span><span class="o">=</span><span class="n">lr_scheduler</span><span class="p">,</span>
                             <span class="o">...</span><span class="p">)</span>
</code></pre></div>
<h4 id="set-learning-rate-for-any-layers-in-feature-network">Set Learning Rate for Any Layers in Feature Network<a class="headerlink" href="#set-learning-rate-for-any-layers-in-feature-network" title="Permanent link">&para;</a></h4>
<p>Similar to adjusting the learning rate of a classifier alone, setting the learning rate of layers in feature network requires a list specifying the learning rate for each layer. Assuming that we only increase the learning rate of the last three layers of the feature network (with prefix features.13, features.14, features.15), the code for creating the optimizer in finetune.py will be changed as follows:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ...</span>


<span class="c1"># Note: a)the params-lr dict must contain all the parameters. b)Also, you&#39;re recommended to set a dict with a key &quot;order_params&quot; to make sure the parameters will be updated in the right order.</span>
<span class="n">params_lr_group</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;features.13&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">())),</span>
                    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mf">1.05</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lr_scheduler</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;features.14&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">())),</span>
                    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lr_scheduler</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;features.15&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">())),</span>
                    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mf">1.15</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lr_scheduler</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
                       <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;features.13&quot;</span><span class="p">,</span> <span class="s2">&quot;features.14&quot;</span><span class="p">,</span> <span class="s2">&quot;features.15&quot;</span><span class="p">],</span>
                       <span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">())),</span>
                    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">lr_scheduler</span><span class="p">},</span>
                   <span class="p">{</span><span class="s2">&quot;order_params&quot;</span><span class="p">:</span> <span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()}]</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">create_optimizer</span><span class="p">(</span><span class="n">params_lr_group</span><span class="p">,</span>
                             <span class="n">opt</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span>
                             <span class="n">lr</span><span class="o">=</span><span class="n">lr_scheduler</span><span class="p">,</span>
                             <span class="o">...</span><span class="p">)</span>
</code></pre></div>
<h2 id="evaluation">Evaluation<a class="headerlink" href="#evaluation" title="Permanent link">&para;</a></h2>
<p>After training, use the model weights stored in <code>*_best-ckpt</code> format in the./ckpt folder to evaluate the performance of the network on the test set. Just <strong>run validate.py</strong> and pass the file path of the model configuration file as well as the model weight to it:</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>validate.py<span class="w"> </span>--config<span class="o">=</span>./configs/mobilenetv3/mobilnet_v3_small_ascend.yaml<span class="w"> </span>--data_dir<span class="o">=</span>./aircraft/data<span class="w"> </span>--ckpt_path<span class="o">=</span>./ckpt/mobilenet_v3_small_100_best.ckpt
</code></pre></div>
<p>The following table summarizes the Top-1 accuracy of the fine-tuned mobilenet v3-small on the Aircraft dataset with the same training configuration but different fine-tuning skills:</p>
<table>
<thead>
<tr>
<th>Network</th>
<th>Freeze All the Feature Work</th>
<th>Freeze Shallow Part of Feature Network</th>
<th>Full Fine-tuning</th>
<th>Full Fine-tuning with Increasing Learning Rate of Classifier</th>
<th>Full Fine-tuning with Increasing Learning Rate of Deep Layers</th>
</tr>
</thead>
<tbody>
<tr>
<td>mobilenet v3-small</td>
<td>48.66%</td>
<td>76.83%</td>
<td>88.35%</td>
<td>88.89%</td>
<td>88.68%</td>
</tr>
</tbody>
</table>
<h2 id="prediction">Prediction<a class="headerlink" href="#prediction" title="Permanent link">&para;</a></h2>
<p>Refer to this section of the MindCV fine-tuning tutorial: <a href="https://mindspore-lab.github.io/mindcv/zh/tutorials/finetune/#12">visual model reasoning results</a>, or add the following code in validate.py to generate a text file ./ckpt/pred.txt that stores the true and predicted labels of the test set:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ... after model.eval()</span>

<span class="c1"># predited label</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># real label</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">loader_eval</span><span class="o">.</span><span class="n">create_tuple_iterator</span><span class="p">())</span>

<span class="c1"># write pred.txt</span>
<span class="n">prediction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pred</span><span class="p">,</span> <span class="n">labels</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s2">&quot;./ckpt/pred.txt&quot;</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s2">&quot;pred </span><span class="se">\t</span><span class="s2"> real&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="appendix">Appendix<a class="headerlink" href="#appendix" title="Permanent link">&para;</a></h2>
<p>The following table shows the Top-1 accuracy (%) of full-model fine-tuning on the Aircraft dataset on several CNNs. For the classification accuracy that can be achieved on this dataset, see <a href="https://fgvc.org/leaderboard/Aircraft.html">Aircraft Leaderboard</a> and <a href="https://paperswithcode.com/sota/fine-grained-image-classification-on-fgvc">Paper With Code</a>.</p>
<table>
<thead>
<tr>
<th>Network</th>
<th>Full Fine-tuning Accuracy with Mindcv</th>
<th>Accuracy in Papers</th>
</tr>
</thead>
<tbody>
<tr>
<td>mobilenet v3-small</td>
<td>88.35%</td>
<td>-</td>
</tr>
<tr>
<td>mobilenet v3-large</td>
<td>92.22%</td>
<td><a href="https://opus.lib.uts.edu.au/handle/10453/156186">83.8%</a></td>
</tr>
<tr>
<td>convnext-tiny</td>
<td>93.69%</td>
<td><a href="http://ise.thss.tsinghua.edu.cn/~mlong/doc/hub-pathway-transfer-learning-nips22.pdf">84.23%</a></td>
</tr>
<tr>
<td>resnest50</td>
<td>86.82%</td>
<td>-</td>
</tr>
</tbody>
</table>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../feature_extraction/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Multi-Scale Feature Extraction">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Multi-Scale Feature Extraction
              </div>
            </div>
          </a>
        
        
          
          <a href="../../reference/data/" class="md-footer__link md-footer__link--next" aria-label="Next: data">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                data
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 - 2023 MindSpore Lab
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="mailto:mindspore-lab@huawei.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/mindspore-lab/mindcv" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.zhihu.com/people/mindsporelab" target="_blank" rel="noopener" title="www.zhihu.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.93-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.indexes", "navigation.top", "navigation.footer", "toc.follow", "search.highlight", "search.share", "search.suggest", "content.action.view", "content.action.edit", "content.tabs.link", "content.code.copy", "content.code.select", "content.code.annotations"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>